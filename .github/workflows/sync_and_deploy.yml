name: Sync and Deploy Workflow

on:
  #  schedule:
  #    - cron: '30 4 * * *'
  #  push:
  #    branches: [ master ]
  pull_request:
    types: [ closed ]
  # å…è®¸ä½ ä» Actions é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµç¨‹
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: sync_and_deploy
  cancel-in-progress: false

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Download and unzip repository
        run: |
          curl -L https://github.com/monocytess/simple/archive/refs/heads/master.zip > repo.zip
          unzip repo.zip
          rm repo.zip

      - name: Sync files
        run: |
          rsync -av --checksum --delete simple-master/src/js30 docs/public/pages/
          rm -rf simple-master

      - name: Modify Html files
        run: |
          find docs/public/pages/js30 -type f -name "*.html" -exec sed -i '/<head>/,/<\/head>/ { s|\./\./\./assets|/assets|g; s|\.\./\.\./common/js30\.base\.js|/assets/common/js30.base.js|g; }' {} \;
          find docs/public/pages/js30 -type f -name "*.html" -exec sed -i '/<head>/,/<\/head>/ { s|href="\./\./\./assets|href="/assets|g; }' {} \;

      - name: Modify Css files
        run: |
          find docs/public/pages/js30 -type f -name "*.css" -exec  sed -i 's|@import "../../css/js30.css";|@import "/assets/css/js30.base.css";|g' {} \;

      - name: Add CardLink to docs/index.md
        run: |
          # æ£€æŸ¥<Flow>æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          if grep -q '<Flow>' docs/index.md; then
            # ä¿å­˜åŸå§‹çš„<Flow>æ ‡ç­¾å†…å®¹
            grep -zoP '(?<=<Flow>).*?(?=</Flow>)' docs/index.md > flow_content.md || echo "" > flow_content.md

            # å°†æ–°çš„CardLinkè¿½åŠ åˆ°åŸå§‹çš„<Flow>å†…å®¹ä¹‹å
            echo "" >> flow_content.md
            for dir in docs/public/pages/js30/*; do
              if [ -d "$dir" ]; then
                folder_name=$(basename "$dir")
                description=$(grep -oP '(?<=<meta name="description" content=").*?(?=">)' "$dir/index.html")
                echo "<CardLink" >> flow_content.md
                echo "  icon=\"$(shuf -n 1 -e ğŸ§­ ğŸ¥ ğŸ¸ ğŸ¹ ğŸº ğŸ» ğŸ·)\"" >> flow_content.md
                echo "  title=\"$folder_name\"" >> flow_content.md
                echo "  description=\"$description\"" >> flow_content.md
                echo "  href=\"/pages/js30/$folder_name/index.html\">" >> flow_content.md
                echo "</CardLink>" >> flow_content.md
              fi
            done
            echo "</Flow>" >> flow_content.md

            # ä½¿ç”¨ `awk` æ›¿æ¢ index.md ä¸­çš„ <Flow> å†…å®¹
            awk '{
              if ($0 ~ /<Flow>/) {
                print $0;
                while (getline line < "flow_content.md") {
                  print line
                }
                while ($0 !~ /<\/Flow>/) {
                  getline
                }
              } else {
                print $0
              }
            }' docs/index.md > docs/index_temp.md && mv docs/index_temp.md docs/index.md
          else
            echo "<Flow>æ ‡ç­¾æœªæ‰¾åˆ°ï¼Œæ— æ³•è¿›è¡Œä¿®æ”¹" >> docs/index.md
          fi
          rm flow_content.md

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ£€æŸ¥äº‹ä»¶æ˜¯å¦ä¸ºPull Request
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            # è·å–Pull Requestç¼–å·
            pr_number=$(jq -r '.pull_request.number' $GITHUB_EVENT_PATH)
            # åˆ›å»ºæ–°çš„åˆ†æ”¯åç§°
            branch_name="blog/sync-auto${pr_number}"
            # åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯
            git checkout -b $branch_name
          fi
          
          git add .
          git commit -m "Automated changes by GitHub Actions"
          # å¦‚æœæ˜¯Pull Requestï¼Œæ¨é€æ›´æ”¹
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            git push -u https://${GITHUB_TOKEN}@github.com/hviwen/hviwen.github.io.git HEAD:$branch_name -f
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
