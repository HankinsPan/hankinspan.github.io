name: Sync and Deploy Workflow

on:
#  schedule:
#    - cron: '30 4 * * *'
  push:
    branches: [ master ]
  # å…è®¸ä½ ä» Actions é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµç¨‹
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
    group: sync_and_deploy
    cancel-in-progress: false

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å¦‚æœæœªå¯ç”¨ lastUpdatedï¼Œåˆ™ä¸éœ€è¦
          uses: pnpm/action-setup@v3

      - name: Setup Node
        uses: actions/setup-node@v4

      - name: Download and unzip repository
        run: |
          curl -L https://github.com/monocytess/simple/archive/refs/heads/master.zip > repo.zip
          unzip repo.zip
          rm repo.zip

      - name: Sync files
        run: |
          rsync -av --checksum --delete simple-master/src/js30 docs/public/pages/
          rm -rf simple-master

      - name: Modify Html files
        run: |
          find docs/public/pages/js30 -type f -name "*.html" -exec sed -i '/<head>/,/<\/head>/ { s|\./\./\./assets|/assets|g; s|\.\./\.\./common/js30\.base\.js|/assets/common/js30.base.js|g; }' {} \;

      - name: Modify Css files
        run: |
          find docs/public/pages/js30 -type f -name "*.css" -exec  sed -i 's|@import "../../css/js30.css";|@import "/assets/css/js30.base.css";|g' {} \;

      - name:  Add CardLink to docs/index.md
        run: |
          echo "<Flow>" > temp.md
          for dir in docs/public/pages/*; do
            if [ -d "$dir" ]; then
              folder_name=$(basename $dir)
              if ! grep -q "$folder_name" docs/index.md; then
                description=$(grep -oP '(?<=<meta name="description" content=").*?(?=">)' $dir/index.html)
                echo "<CardLink" >> temp.md
                echo "  icon=\"$(shuf -n 1 -e ğŸ§­ ğŸ¥ ğŸ¸ ğŸ¹ ğŸº ğŸ» ğŸ·)\"" >> temp.md
                echo "  title=\"$folder_name\"" >> temp.md
                echo "  description=\"$description\"" >> temp.md
                echo "  href=\"/pages/js30/$folder_name/index.html\">" >> temp.md
                echo "</CardLink>" >> temp.md
              fi
            fi
          done
          echo "</Flow>" >> temp.md
          sed -i '/<Flow>/,/<\/Flow>/d' docs/index.md
          cat temp.md >> docs/index.md
          rm temp.md

      - name: Commit and push changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # æ‹‰å–è¿œç¨‹åˆ†æ”¯çš„æœ€æ–°æ›´æ”¹
          git fetch origin blog/sync-auto
          # ä¸è¿œç¨‹åˆ†æ”¯åˆå¹¶
          git rebase origin/blog/sync-auto
          git add .
          git commit -m "Automated changes by GitHub Actions"
          git push https://${GITHUB_TOKEN}@github.com/hviwen/hviwen.github.io.git HEAD:blog/sync-auto -f
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
